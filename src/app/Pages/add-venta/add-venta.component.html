<div class="container">
  <h2 class="titulo">Registrar Venta</h2>

  <form [formGroup]="ventaForm">

    <div class="form-layout">

      <mat-form-field appearance="fill" class="form-field" style="width: 85%;">
        
        <mat-label>Cliente</mat-label>
        <input type="text" matInput [matAutocomplete]="autoCliente" formControlName="clienteId" (input)="filtrarClientes($event)">
        <mat-autocomplete #autoCliente="matAutocomplete" [displayWith]="displayCLiente">
          <mat-option *ngFor="let cliente of ClienteFiltrados" [value]="cliente.id">
            {{ cliente.nombreCliente }} - {{ cliente.telefono }} 
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>

      <button mat-icon-button color="primary" style="vertical-align: top; margin-top: 12px;" (click)="abrirModalCrearCliente()">
        <mat-icon>person_add</mat-icon>
      </button>

      <mat-form-field appearance="fill" class="form-field">
        <mat-label>Tipo de Transacción</mat-label>
        <mat-select formControlName="tipoTransaccionId">
          <mat-option *ngFor="let tipo of Tipotransaccionlista" [value]="tipo.id">
            {{ tipo.descripcion }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <button mat-raised-button color="primary" type="button" (click)="abrirDialogBuscarProducto()">
        <mat-icon>add_shopping_cart</mat-icon> Agregar Producto
      </button>

    </div>
  </form>

  <h4 class="subtitulo">Detalle de Productos 
    <span class="badge">{{ detalleDataSource.data.length }} productos</span>
  </h4>

  <mat-form-field appearance="fill" style="width: 300px; margin-bottom: 16px;">
    <mat-label>Buscar producto en la venta</mat-label>
    <input matInput type="text" [(ngModel)]="filtroDetalle" (ngModelChange)="aplicarFiltroDetalle()" placeholder="Ej. paracetamol">
    <button *ngIf="filtroDetalle" matSuffix mat-icon-button aria-label="Limpiar" (click)="limpiarFiltroDetalle()">
      <mat-icon>close</mat-icon>
    </button>
  </mat-form-field>


  <div class="table-container">
    <table mat-table [dataSource]="detalleDataSource" class="mat-elevation-z2">

      <ng-container matColumnDef="producto">
        <th mat-header-cell *matHeaderCellDef> Producto </th>
        <td mat-cell *matCellDef="let element"> {{element.nombreProducto}} </td>
      </ng-container>

      <ng-container matColumnDef="unidadMedidaNombre">
        <th mat-header-cell *matHeaderCellDef> Unidad Medida </th>
        <td mat-cell *matCellDef="let element"> {{element.unidadMedidaNombre}} </td>
      </ng-container>

      <ng-container matColumnDef="precio">
        <th mat-header-cell *matHeaderCellDef> Precio </th>
        <td mat-cell *matCellDef="let element; let i = index">
          <input type="number"
               [(ngModel)]="element.precioVentaUnitario"
                (ngModelChange)="calcularTotalCompra()"
                min="0"
                class="editable-input"
                placeholder="L." />
        </td>
      </ng-container>

    <ng-container matColumnDef="cantidad">
        <th mat-header-cell *matHeaderCellDef> Cantidad </th>
        <td mat-cell *matCellDef="let element; let i = index">
          <input type="number"
               [(ngModel)]="element.cantidad"
                (ngModelChange)="calcularTotalCompra()"
                min="0"
                class="editable-input"
                placeholder="0" />
        </td>
    </ng-container>

    <ng-container matColumnDef="subtotal">
      <th mat-header-cell *matHeaderCellDef> Subtotal </th>
      <td mat-cell *matCellDef="let element; let i = index">
        <input type="number"
              [(ngModel)]="element.subtotal"
              (ngModelChange)="actualizarPrecioDesdeSubtotal(i)"
              min="0"
              class="editable-input"
              placeholder="L." />
      </td>
    </ng-container>



      <ng-container matColumnDef="acciones">
        <th mat-header-cell *matHeaderCellDef> Acciones </th>
        <td mat-cell *matCellDef="let element; let i = index">
          <button mat-icon-button color="warn" (click)="detalleDataSource.data.splice(i,1); detalleDataSource._updateChangeSubscription(); calcularTotalCompra()">
            <mat-icon>delete</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="columnasTabla"></tr>
      <tr mat-row *matRowDef="let row; columns: columnasTabla;"></tr>

    </table>
  </div>

  <div class="total-section">
    <h3>Total: <span> {{ totalCompra | currency:'HNL':'symbol' }}</span></h3>
  </div>

  <div class="button-container">
    <!-- Botón para registrar la venta -->
    <button mat-raised-button color="accent" 
        (click)="CrearVenta()" 
        [disabled]="detalleDataSource.data.length === 0 || ventaForm.invalid || isSaving">
      <mat-icon *ngIf="!isSaving">save</mat-icon>
      <mat-spinner *ngIf="isSaving" diameter="20"></mat-spinner>
      {{ isSaving ? 'Guardando...' : 'Registrar Venta' }}
   </button>


    <!-- Botón para limpiar el formulario -->
    <button mat-raised-button color="warn" (click)="limpiarformulario()">
      <mat-icon>delete_sweep</mat-icon>
    </button>

    
  <!-- Botón para generar cotización -->
  <button mat-raised-button color="primary" (click)="generarCotizacionDesdeFormulario()" [disabled]="detalleDataSource.data.length === 0">
    <mat-icon>picture_as_pdf</mat-icon> Cotizar
  </button>

  </div>

</div>
