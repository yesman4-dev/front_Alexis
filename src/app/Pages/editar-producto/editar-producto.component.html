<form [formGroup]="productoForm" class="producto-form mat-elevation-z4">
    <div class="form-card">
      <h2 class="form-title">Editar producto</h2>

  
      <div class="imagen-uploader">
        <label class="upload-label">Seleccionar imagen</label>
        <input type="file" (change)="onImageSelect($event, 'imagenURL')" accept="image/*" />
      
        <!-- Vista previa -->
        <div class="preview-container" *ngIf="productoForm.get('imagenURL')?.value">
          <img [src]="productoForm.get('imagenURL')?.value" alt="Vista previa de imagen" class="preview-img" />
        </div>
      </div>
      
      <h1></h1>
  
      <div class="form-grid">
  
        <mat-form-field appearance="outline">
          <mat-label>Código del producto</mat-label>
          <input 
            type="text" 
            matInput 
            formControlName="codigoProducto"
            [matAutocomplete]="autoCodigo"
          />
          <mat-autocomplete #autoCodigo="matAutocomplete" (optionSelected)="seleccionarProducto($event)">
            <mat-option *ngFor="let p of productosFiltrados" [value]="p.codigoProducto">
              {{ p.codigoProducto }} - {{ p.nombreProducto }}- {{ p.laboratorioNombre }}
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>
        
  
        <mat-form-field appearance="outline">
          <mat-label>Nombre del producto</mat-label>
          <input matInput formControlName="nombreProducto" />
        </mat-form-field>
  
        <mat-form-field appearance="outline">
          <mat-label>Descripción corta</mat-label>
          <input matInput formControlName="descripcionCorta" />
        </mat-form-field>
  
        <mat-form-field appearance="outline">
          <mat-label>Descripción larga</mat-label>
          <textarea matInput formControlName="descripcionLarga"></textarea>
        </mat-form-field>
  
        <mat-form-field appearance="outline">
          <mat-label>Descuento por cantidad</mat-label>
          <input matInput type="number" formControlName="descuentoPorCantidad" />
        </mat-form-field>
  

        <mat-form-field appearance="outline">
          <mat-label>Stock  en general</mat-label>
          <input matInput type="number" formControlName="stockActual" />
        </mat-form-field>
        
  
        <mat-form-field appearance="outline">
          <mat-label>Código de barras</mat-label>
          <input matInput formControlName="codigoBarras" />
        </mat-form-field>
  
        <mat-form-field appearance="outline">
          <mat-label>Categoría</mat-label>
          <mat-select formControlName="categoriaProductoId">
            <mat-option *ngFor="let c of categorialista" [value]="c.id">{{ c.descripcion }}</mat-option>
          </mat-select>
        </mat-form-field>
  
        <mat-form-field appearance="outline">
          <mat-label>Laboratorio</mat-label>
          <mat-select formControlName="laboratorioId">
            <mat-option *ngFor="let l of laboratoriolista" [value]="l.id">{{ l.descripcion }}</mat-option>
          </mat-select>
        </mat-form-field>
  
        <mat-form-field appearance="outline">
          <mat-label>Presentación</mat-label>
          <mat-select formControlName="presentacionContenidoId">
            <mat-option *ngFor="let p of presentacionlista" [value]="p.id">{{ p.descripcion }}</mat-option>
          </mat-select>
        </mat-form-field>
  
        <mat-form-field appearance="outline">
          <mat-label>Unidad de medida principal</mat-label>
          <mat-select formControlName="unidadMedidaId">
            <mat-option *ngFor="let u of unidaddeMedidalista" [value]="u.id">{{ u.descripcion }}</mat-option>
          </mat-select>
        </mat-form-field>
  
        <mat-form-field appearance="outline">
          <mat-label>Precio de venta principal</mat-label>
          <input matInput type="number" formControlName="precioVenta" />
        </mat-form-field>

     
  
        <div class="checkbox-wrapper">
          <mat-checkbox formControlName="esFracionable">¿Es fraccionable?</mat-checkbox>
        </div>

        <div class="checkbox-wrapper" *ngIf="username === 'AdminA'">
          <mat-checkbox formControlName="esProductoEspecial">¿Es Especial?</mat-checkbox>
        </div>

        <div class="checkbox-wrapper" *ngIf="idRol !== 2">
         <!-- Estado Activo/Inactivo -->
         <mat-slide-toggle 
         id="esActivo"
         formControlName="esActivo"
         (change)="onDisponibleChange($event)">
         Es Activo
       </mat-slide-toggle>
      </div>
  
      </div>
    </div>
  
    <!-- Sección fraccionable -->
    <div *ngIf="productoForm.get('esFracionable')?.value" class="form-card">
      <h2 class="form-title">Opciones de venta fraccionada</h2>
  
      <div class="venta-form-row">
        <mat-form-field appearance="outline">
          <mat-label>Unidad de medida</mat-label>
          <mat-select [(ngModel)]="nuevaOpcion.unidadMedidaId" [ngModelOptions]="{ standalone: true }">
            <mat-option *ngFor="let u of unidaddeMedidalista" [value]="u.id">{{ u.descripcion }}</mat-option>
          </mat-select>
        </mat-form-field>
  
        <mat-form-field appearance="outline">
          <mat-label>Cantidad</mat-label>
          <input matInput type="number" [(ngModel)]="nuevaOpcion.cantidadPorUnidad" [ngModelOptions]="{ standalone: true }" />
        </mat-form-field>
  
        <mat-form-field appearance="outline">
          <mat-label>Precio</mat-label>
          <input matInput type="number" [(ngModel)]="nuevaOpcion.precioVenta" [ngModelOptions]="{ standalone: true }" />
        </mat-form-field>
  
        <button mat-raised-button color="primary" type="button" (click)="agregarUnidadDeMedidaAProducto()" *ngIf="idRol !== 2">
          Agregar</button>
      </div>
  
      <table mat-table [dataSource]="opcionesVenta" class="mat-elevation-z1 full-width-table">
        <ng-container matColumnDef="unidadMedidaId">
          <th mat-header-cell *matHeaderCellDef>Unidad</th>
          <td mat-cell *matCellDef="let o">{{ getDescripcionUnidad(o.unidadMedidaId) }}</td>
        </ng-container>
  
        <ng-container matColumnDef="cantidadPorUnidad">
          <th mat-header-cell *matHeaderCellDef>Cantidad</th>
          <td mat-cell *matCellDef="let o">{{ o.cantidadPorUnidad }}</td>
        </ng-container>

        <ng-container matColumnDef="precioVenta">
          <th mat-header-cell *matHeaderCellDef>Precio</th>
          <td mat-cell *matCellDef="let o">
            <input matInput 
                  type="number" 
                  [(ngModel)]="o.precioVenta" 
                  [ngModelOptions]="{ standalone: true }" 
                  (keydown.enter)="onEnterKeyPress($event, o)"  
                  class="editable-input" 
                  placeholder="Precio de venta" />
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="['unidadMedidaId', 'cantidadPorUnidad', 'precioVenta']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['unidadMedidaId', 'cantidadPorUnidad', 'precioVenta'];"></tr>
      </table>
    </div>
  
  
    <div class="botones-container" *ngIf="idRol !== 2">
      <div class="boton-guardar">
        <button mat-raised-button style="background-color: green;" type="button" (click)="modificarProducto()">Modificar producto</button>
      </div>
    
      <div class="boton-cerrar">
        <button mat-raised-button style="background-color: red;" type="button" (click)="cancelar()">Cancelar</button>
      </div>
    </div>
    
    <h1></h1>
    
    <mat-accordion class="producto-accordion">
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>
            Lista de productos registrados
          </mat-panel-title>
          <mat-panel-description>
            Click para ver o editar
          </mat-panel-description>
        </mat-expansion-panel-header>
    
        <!-- Campo de búsqueda -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Buscar producto</mat-label>
          <input matInput (keyup)="filtrarProducto($event)" placeholder="Código, nombre o código de barras..." />
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
        

        <!-- Tabla de productos -->
        <table mat-table [dataSource]="filteredDataSource" class="mat-elevation-z2 full-width-table">
          <ng-container matColumnDef="codigoProducto">
            <th mat-header-cell *matHeaderCellDef>Código</th>
            <td mat-cell *matCellDef="let element">{{ element.codigoProducto }}</td>
          </ng-container>
    
          <ng-container matColumnDef="nombreProducto">
            <th mat-header-cell *matHeaderCellDef>Nombre</th>
            <td mat-cell *matCellDef="let element">{{ element.nombreProducto }}</td>
          </ng-container>
    
          <ng-container matColumnDef="laboratorioId">
            <th mat-header-cell *matHeaderCellDef>Laboratorio</th>
            <td mat-cell *matCellDef="let element">{{ getNombreLaboratorio(element.laboratorioId) }}</td>
          </ng-container>
    
          <ng-container matColumnDef="precioCompra" >
            <th mat-header-cell *matHeaderCellDef>Precio Compra</th>
            <td mat-cell *matCellDef="let element">{{ element.precioCompra | currency:'HNL' }}</td>
          </ng-container>
    
          <ng-container matColumnDef="precioVenta">
            <th mat-header-cell *matHeaderCellDef>Precio Venta</th>
            <td mat-cell *matCellDef="let element">{{ element.precioVenta | currency:'HNL' }}</td>
          </ng-container>
    
          <ng-container matColumnDef="stockActual">
            <th mat-header-cell *matHeaderCellDef>Stock General</th>
            <td mat-cell *matCellDef="let element">{{ element.stockActual }}</td>
          </ng-container>

          <ng-container matColumnDef="esFracionable">
            <th mat-header-cell *matHeaderCellDef>Es Fracionable</th>
            <td mat-cell *matCellDef="let element">{{ element.esFracionable }}</td>
          </ng-container>
    
          <ng-container matColumnDef="acciones">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let element" >
            <button mat-icon-button color="primary" (click)="abrirModalInventario(element)">
              <mat-icon>add_box</mat-icon>
            </button>

            </td>
          </ng-container>
    
          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </mat-expansion-panel>
    </mat-accordion>
    
  
  </form>
  